!function(app){"use strict";function makeRequest(params,successCallback,errorCallback){var xhr=new XMLHttpRequest,url=-1===params.url.indexOf("https")?app.Config.apiBaseURL+params.url:params.url;xhr.open(params.method,encodeURI(url)),xhr.setRequestHeader("Content-Type","application/json"),xhr.setRequestHeader("Authorization","Bearer "+app.Utils.ajax.token),params.headers&&setHeaders(xhr,params.headers),xhr.onload=function(){if(200!==xhr.status&&201!==xhr.status||"function"!=typeof successCallback){if("function"==typeof errorCallback){var resp=""!==xhr.responseText?JSON.parse(xhr.responseText):"",error=resp.error,msg=error.status+": "+error.message;errorCallback(new Error(msg))}}else{var resp=""!==xhr.responseText?JSON.parse(xhr.responseText):"";successCallback(resp,xhr)}},params.data?xhr.send(params.data):xhr.send()}function setHeaders(xhr,headersObj){for(var hName in headersObj)headersObj.hasOwnProperty(hName)&&xhr.setRequestHeader(hName,headersObj[hName])}app.Utils=app.Utils||{},app.Utils.ajax={},app.Utils.ajax.get=function(params,success,error){params.method="GET",makeRequest(params,success,error)},app.Utils.ajax.post=function(params,success,error){params.method="POST",params.data=params.data?JSON.stringify(params.data):"",makeRequest(params,success,error)},app.Utils.ajax.put=function(params,success,error){params.method="PUT",params.data=params.data?JSON.stringify(params.data):"",makeRequest(params,success,error)},app.Utils.ajax["delete"]=function(params,success,error){params.method="DELETE",params.data=params.data?JSON.stringify(params.data):"",makeRequest(params,success,error)}}(MYSP),function(app){"use strict";app.Utils=app.Utils||{},app.Utils.hashToObject=function(hash){var obj={};return 0===hash.indexOf("#")&&(hash=hash.substr(1)),hash.split("&").forEach(function(kv){var split=kv.indexOf("=");-1!=split&&(obj[kv.substring(0,split)]=decodeURIComponent(kv.substring(split+1)))}),obj},app.Utils.objToQuerystring=function(object){var encodedString="";for(var prop in object)object.hasOwnProperty(prop)&&(encodedString.length>0&&(encodedString+="&"),encodedString+=encodeURI(prop+"="+object[prop]));return encodedString}}(MYSP),function(app){"use strict";app.Utils=app.Utils||{},app.Utils.formatTime=function(ms){var secs=Math.floor(ms/1e3),hrs=Math.floor(secs/3600),minutes=Math.floor(secs/60)-60*hrs,secs=secs-60*hrs*60-60*minutes,hrsString="";return hrs>0&&(hrsString+=hrs+":",minutes=10>minutes?"0"+minutes:minutes),secs=10>secs?"0"+secs:secs,hrsString+minutes+":"+secs}}(MYSP),function(app){"use strict";var Auth=function(config){this.clientId=config.clientId,this.authApiUrl=config.authApiUrl,this.authCallback=config.host+config.authCallback,this.authScopes=config.authScopes,this.appPrefix=config.appPrefix};Auth.prototype.buildAuthUrl=function(){return this.authApiUrl+"?client_id="+this.clientId+"&redirect_uri="+encodeURIComponent(this.authCallback)+"&scope="+encodeURIComponent(this.authScopes.join(" "))+"&response_type=token"},Auth.prototype.login=function(){var url=this.buildAuthUrl();window.open(url,"Spotify","menubar=no,location=no,resizable=no,scrollbars=no,status=no")},Auth.prototype.logout=function(){this.setId(""),this.setToken("",""),window.location.reload()},Auth.prototype.setToken=function(token,expires_in){localStorage.setItem(this.appPrefix+"token",token),localStorage.setItem(this.appPrefix+"expires",expires_in?(new Date).getTime()+expires_in:"")},Auth.prototype.getToken=function(){var expires=0+localStorage.getItem(this.appPrefix+"expires")||0;if((new Date).getTime()>expires)return"";var token=localStorage.getItem(this.appPrefix+"token")||"";return token},Auth.prototype.setId=function(username){localStorage.setItem(this.appPrefix+"id",username)},Auth.prototype.getId=function(){var username=localStorage.getItem(this.appPrefix+"id")||"";return username},Auth.prototype.addLoginCallbackListener=function(){var self=this;window.addEventListener("message",function(event){var hash=JSON.parse(event.data);"access_token"==hash.type&&self.setToken(hash.access_token,hash.expires_in||60),window.location.reload()},!1)},app.Models.Auth=Auth}(MYSP),function(app){"use strict";var Events=function(){this.subscriptions={}};Events.prototype={subscribe:function(eventName,callback){this.subscriptions[eventName]||(this.subscriptions[eventName]=[]),this.subscriptions[eventName].push(callback)},publish:function(eventName,data){this.subscriptions[eventName]&&this.subscriptions[eventName].forEach(function(callback){callback(data)})}},app.Models.Events=Events}(MYSP),function(app){"use strict";var Playlist=function(ajaxService){this.data={},this.tracks=[],this.tracksObjMap={},this.ajaxService=ajaxService};Playlist.prototype.reset=function(){this.data={},this.tracks=[],this.tracksObjMap={}},Playlist.prototype.getId=function(){return this.data.id},Playlist.prototype.getName=function(){return this.data.name},Playlist.prototype.setName=function(name){this.data.name=name},Playlist.prototype.isPublic=function(){return this.data["public"]},Playlist.prototype.setPublic=function(isPublic){this.data["public"]=isPublic},Playlist.prototype.setProfile=function(playlistObj){this.data=playlistObj},Playlist.prototype.getData=function(){return this.data},Playlist.prototype.getTracks=function(){return this.tracks},Playlist.prototype.getTrackModel=function(trackUri){return this.tracksObjMap[trackUri]?this.tracksObjMap[trackUri]:null},Playlist.prototype.getImage=function(size){var img="";if(1===this.data.images.length)img=this.data.images[0].url;else if(this.data.images.length>1){var index=0;switch(size){case"large":index=0;break;case"medium":index=1;break;case"small":index=2}img=this.data.images[index].url}return img},Playlist.prototype.loadTracks=function(callback){var self=this;this.ajaxService.get({url:self.data.tracks.href},function(response){response.items.forEach(function(obj){self.tracks.push(obj.track),self.tracksObjMap[obj.track.uri]=obj.track}),callback(null,self.tracks)},function(err){callback(err)})},Playlist.prototype.updatePlaylistDetails=function(data,callback){var self=this;this.ajaxService.put({url:self.data.href,data:data},function(){self.data.name=data.name||self.data.name,self.data["public"]=data["public"]||self.data["public"],callback()},function(err){callback(err)})},Playlist.prototype.createPlaylist=function(username,data,callback){var self=this;this.ajaxService.post({url:"/users/"+encodeURIComponent(username)+"/playlists",data:data},function(response){self.data=response,callback(null,response)},function(err){callback(err,null)})},Playlist.prototype.addTracks=function(uris,callback){var self=this;this.ajaxService.post({url:self.data.tracks.href,data:{uris:uris}},function(response){self.data.snapshot_id=response.snapshot_id,callback()},function(err){callback(err)})},Playlist.prototype.removeTrack=function(uri,callback){var self=this;this.ajaxService["delete"]({url:self.data.tracks.href,data:{tracks:[{uri:uri}]}},function(response){self.data.snapshot_id=response.snapshot_id,callback()},function(err){callback(err)})},Playlist.prototype.appendToObjMap=function(tracks){tracks.forEach(function(t){this.tracksObjMap[t.uri]=t},this)},app.Models.Playlist=Playlist}(MYSP),function(app){"use strict";var Queue=function(config){this.appPrefix=config.appPrefix,this.tracks=[]};Queue.prototype.getTracks=function(){if(0===this.tracks.length){var tracks=localStorage.getItem(this.appPrefix+"queue")||"[]";this.tracks=JSON.parse(tracks)}return this.tracks},Queue.prototype.addTracks=function(tracks){if(tracks){var currentTracks=this.getTracks();Array.isArray(tracks)?tracks.forEach(function(t){currentTracks.push(t)},this):currentTracks.push(tracks),this.saveQueue(currentTracks)}},Queue.prototype.removeTrack=function(trackOrder){var tracks=this.getTracks();tracks.splice(parseInt(trackOrder,10),1),this.saveQueue(tracks)},Queue.prototype.saveQueue=function(tracks){this.tracks=tracks,localStorage.setItem(this.appPrefix+"queue",JSON.stringify(tracks))},Queue.prototype.getTrack=function(index){var tracks=this.getTracks();return tracks[index]},Queue.prototype.getLength=function(){var tracks=this.getTracks();return tracks.length},app.Models.Queue=Queue}(MYSP),function(app){"use strict";var Search=function(ajaxService){this.tracks=[],this.tracksObjMap={},this.nextResultsUrl="",this.currentQuery="",this.ajaxService=ajaxService};Search.prototype.loadResults=function(query,callback){this.currentQuery===query&&this.tracks.length>0?callback(null,this.tracks):(this.reset(query),this.makeSearchRequest({url:"/search?type=track&q="+query+"&market=from_token"},callback))},Search.prototype.loadNextResults=function(callback){this.makeSearchRequest({url:this.nextResultsUrl},callback)},Search.prototype.reset=function(q){this.currentQuery=q,this.nextResultsUrl="",this.tracks=[],this.tracksObjMap={}},Search.prototype.hasNextResults=function(){return!!this.nextResultsUrl},Search.prototype.makeSearchRequest=function(options,callback){var self=this;this.ajaxService.get(options,function(response){response.tracks.items&&(self.tracks=self.tracks.concat(response.tracks.items),self.appendToObjMap(response.tracks.items),self.nextResultsUrl=response.tracks.next,callback(null,self.tracks))},function(err){callback(err)})},Search.prototype.appendToObjMap=function(tracks){tracks.forEach(function(t){this.tracksObjMap[t.uri]=t},this)},Search.prototype.getTrackModel=function(trackUri){return this.tracksObjMap[trackUri]?this.tracksObjMap[trackUri]:null},app.Models.Search=Search}(MYSP),function(app){"use strict";var User=function(ajaxService){this.profile={},this.playlists={},this.ajaxService=ajaxService};User.prototype.getId=function(){return this.profile.id},User.prototype.getName=function(){return this.profile.display_name||this.profile.id},User.prototype.getProfile=function(){return this.profile},User.prototype.getPlaylists=function(){return this.playlists.items},User.prototype.getPlaylist=function(playlistId){return this.playlists.items[playlistId]||null},User.prototype.setPlaylist=function(playlistObj){this.playlists.items[playlistObj.id]=playlistObj},User.prototype.loadProfile=function(callback){var self=this;this.ajaxService.get({url:"/me"},function(data){self.profile=data,callback(null,self)},function(err){callback(err,null)})},User.prototype.loadPlaylists=function(callback){var limit=50,offset=0,self=this;this.ajaxService.get({url:"/users/"+encodeURIComponent(this.getId())+"/playlists?offset="+offset+"&limit="+limit},function(response){self.playlists=response;var itemsObj={};self.playlists.items.forEach(function(pl){itemsObj[pl.id]=pl},this),self.playlists.items=itemsObj,callback()},function(err){callback(err)})},app.Models.User=User}(MYSP),function(app){"use strict";var CoreView=function(options){this.element=null,this.subscribed=!1,this.elementId=options.element,this.subViews=options.subViews||{},this.route=options.route||{}};CoreView.prototype.render=function(){this.renderSelf(),this.renderSubviews()},CoreView.prototype.renderSelf=function(ignoreBinding){this.element=document.getElementById(this.elementId),this.element.innerHTML=this.getTemplate(),ignoreBinding||this.addEventListeners()},CoreView.prototype.renderSubviews=function(){for(var v in this.subViews)this.subViews.hasOwnProperty(v)&&this.subViews[v].render()},CoreView.prototype.getTemplate=function(){return""},CoreView.prototype.addEventListeners=function(){},CoreView.prototype.updateRoute=function(newRoute){this.route=newRoute},CoreView.prototype.updateSubviewsRoute=function(newRoute){for(var v in this.subViews)this.subViews.hasOwnProperty(v)&&this.subViews[v].updateRoute(newRoute)},CoreView.prototype.goTo=function(route){window.location.hash=app.Utils.objToQuerystring(route)},CoreView.prototype.addListener=function(selector,eventName,callback){function addListenerById(elementId,eventName,callback){var element=document.getElementById(elementId);element&&element.addEventListener(eventName,function(){callback()},!1)}function addListenerByClass(className,eventName,callback){var elements=document.getElementsByClassName(className);if(elements.length)for(var nbrElements=elements.length,i=0;nbrElements>i;i++)elements[i].addEventListener(eventName,function(){callback()},!1)}var cleanSelector=selector.substring(1);switch(selector.charAt(0)){case"#":addListenerById(cleanSelector,eventName,callback);break;case".":addListenerByClass(cleanSelector,eventName,callback)}},app.Views.CoreView=CoreView}(MYSP),function(app){"use strict";var LoggerView=function(options){app.Views.CoreView.call(this,options),this.msgType="",this.msg="",this.timeout=null,this.appEvents=options.events};LoggerView.prototype=Object.create(app.Views.CoreView.prototype),LoggerView.prototype.addEventListeners=function(){this.subscribed||(this.subscribed=!0,this.appEvents.subscribe("logMsg",this.displayMessage.bind(this)))},LoggerView.prototype.displayMessage=function(data){this.msgType=data.type,this.msg=data.msg,this.render();var self=this;this.timeout=null,this.timeout=setTimeout(function(){self.msg="",self.render()},3e3)},LoggerView.prototype.getTemplate=function(){return""===this.msg?"":'<div class="mysp-alert-'+this.msgType+'">'+this.msg+"</div>"},app.Views.LoggerView=LoggerView}(MYSP),function(app){"use strict";var PlayerView=function(options){app.Views.CoreView.call(this,options),this.currentTrack={index:null,model:null,length:0},this.isPlaying=!1,this.appEvents=options.events,this.queueModel=options.queueModel};PlayerView.prototype=Object.create(app.Views.CoreView.prototype),PlayerView.prototype.addEventListeners=function(){this.addListener("#mysp-player-play","click",this.play.bind(this)),this.addListener("#mysp-player-stop","click",this.stop.bind(this)),this.addListener("#mysp-player-next","click",this.next.bind(this)),this.addListener("#mysp-player-prev","click",this.prev.bind(this))},PlayerView.prototype.play=function(){if(!this.isEmptyQueue()&&!this.isPlaying){var self=this,curTime=this.currentTrack.length;this.isPlaying=setInterval(function(){curTime>=0?(self.showCurrentTime(self.currentTrack.length-curTime),curTime-=300):self.next()},300)}},PlayerView.prototype.stop=function(){clearInterval(this.isPlaying),this.isPlaying=!1,this.showCurrentTime(0)},PlayerView.prototype.next=function(){this.playTrack(this.currentTrack.index+1)},PlayerView.prototype.prev=function(){this.playTrack(this.currentTrack.index-1)},PlayerView.prototype.playTrack=function(trackIndex){if(!this.isEmptyQueue()){this.stop();var nbrIndexes=this.queueModel.getLength()-1;trackIndex>nbrIndexes&&(trackIndex=0);var track=this.queueModel.getTrack(trackIndex);this.setCurrentTrack(trackIndex,track),this.play(),this.showCurrentTrackInfo()}},PlayerView.prototype.render=function(){this.renderSelf(),null===this.currentTrack.index&&this.initPlayer(),this.showCurrentTrackInfo()},PlayerView.prototype.setCurrentTrack=function(index,trackModel){this.currentTrack={index:index,model:trackModel,playTime:0,length:trackModel.duration_ms}},PlayerView.prototype.isEmptyQueue=function(){var queueLength=this.queueModel.getLength();return 0===queueLength?(this.appEvents.publish("logMsg",{type:"info",msg:"Playing queue is empty"}),!0):!1},PlayerView.prototype.initPlayer=function(){if(!this.isEmptyQueue()){var trackModel=this.queueModel.getTrack(0);this.setCurrentTrack(0,trackModel)}},PlayerView.prototype.showCurrentTrackInfo=function(){if(null!==this.currentTrack.index){var trackLength=this.currentTrack.length,trackName=this.currentTrack.model.name,artistName=this.currentTrack.model.artists[0].name,infoElement=this.element.getElementsByClassName("mysp-current-track")[0];infoElement.innerHTML=trackName+" - "+artistName+" - "+app.Utils.formatTime(trackLength)}},PlayerView.prototype.showCurrentTime=function(time){document.getElementById("mysp-player-time").innerHTML=app.Utils.formatTime(time)},PlayerView.prototype.getTemplate=function(){return'<div class="mysp-player clearfix"><a id="mysp-player-queue" href="#page=queue" class="mysp-player-btn">&#8694;</a><div class="mysp-player-btn" id="mysp-player-next">&#9654;&#9654;</div><div class="mysp-player-btn" id="mysp-player-stop">&#9632;</div><div class="mysp-player-btn" id="mysp-player-play">&#9654;</div><div class="mysp-player-btn" id="mysp-player-prev">&#9664;&#9664;</div><div class="mysp-player-time" id="mysp-player-time">0:00</div></div><div class="mysp-current-track truncated"></div>'},app.Views.PlayerView=PlayerView}(MYSP),function(app){"use strict";var AppView=function(options){app.Views.CoreView.call(this,options),this.auth=options.auth,this.user=options.user};AppView.prototype=Object.create(app.Views.CoreView.prototype),AppView.prototype.addEventListeners=function(){var self=this;this.addListener("#btn-logout","click",function(){self.auth.logout()})},AppView.prototype.getTemplate=function(){return'<header class="row"><div class="col-1-3"><a href="#page=search" class="mysp-title"><h1>MY<br/>SP</h1></a></div><div class="col-1-3 text-center" id="mysp-info-box"></div><div class="col-1-3 text-right"><div class="row">Welcome <strong class="mysp-logged-user-name">'+this.user.getName()+'</strong>,&nbsp; <a href="#" id="btn-logout">Logout</a></div><div id="mysp-player-container" class="row text-right"></div></div></header><div class="row"><div id="mysp-menu" class="col-1-3"></div><div id="mysp-content" class="col-2-3"></div></div>'},app.Views.AppView=AppView}(MYSP),function(app){"use strict";var LoginView=function(options){app.Views.CoreView.call(this,options),this.auth=options.auth};LoginView.prototype=Object.create(app.Views.CoreView.prototype),LoginView.prototype.addEventListeners=function(){var self=this;this.addListener("#btn-login","click",function(){self.auth.login()})},LoginView.prototype.getTemplate=function(){return'<div id="loginForm"><div class="mysp-login-wrapper clearfix"><div class="mysp-login-page-column"><h1 class="mysp-login-logo">MY<br/>SP</h1><h4>Welcome to <b>MY Spotify Player</b></h4></div><div class="mysp-login-page-column"><a id="btn-login" href="#"><span class="spotify-logo"><h3>Login with Spotify</h3></span></a></div></div></div>'},app.Views.LoginView=LoginView}(MYSP),function(app){"use strict";var MenuView=function(options){app.Views.CoreView.call(this,options)};MenuView.prototype=Object.create(app.Views.CoreView.prototype),MenuView.prototype.getTemplate=function(){return'<div id="mysp-menu-search" class="menu-section"></div><div id="mysp-menu-playlists" class="menu-section"></div>'},app.Views.MenuView=MenuView}(MYSP),function(app){"use strict";var PlaylistsMenuView=function(options){app.Views.CoreView.call(this,options),this.user=options.user,this.appEvents=options.events,this.playlistModel=options.playlistModel};PlaylistsMenuView.prototype=Object.create(app.Views.CoreView.prototype),PlaylistsMenuView.prototype.addEventListeners=function(){this.subscribed||(this.subscribed=!0,this.appEvents.subscribe("playlistDetailsUpdate",this.render.bind(this))),this.addListener("#menu-add-playlist-link","click",this.showNewPlaylistForm.bind(this)),this.addListener(".menu-new-playlist-cancel-btn","click",this.hideNewPlaylistForm.bind(this)),this.addListener(".menu-new-playlist-save-btn","click",this.saveNewPlaylist.bind(this))},PlaylistsMenuView.prototype.render=function(){this.renderSelf();var content="",playlists=this.user.getPlaylists(),menuList=this.element.getElementsByClassName("menu-items-list")[0];for(var pl in playlists)playlists.hasOwnProperty(pl)&&(content+=this.drawPlaylistLink(playlists[pl]));menuList.innerHTML=content},PlaylistsMenuView.prototype.getTemplate=function(){return'<h2 class="menu-section-header">Playlists</h2><a id="menu-add-playlist-link" class="btn" href="#">+ Add new playlist</a><div class="menu-add-playlist-form hidden"><div class="form-row"><input type="text" class="new-playlist-name" name="new-playlist-name" value=""/></div><div class="form-row">Private <input type="radio" class="new-playlist-type private-playlist" name="new-playlist-type" value="private" checked />&nbsp;Public <input type="radio" class="new-playlist-type public-playlist" name="new-playlist-type" value="public"/></div><div class="form-row"><button class="menu-new-playlist-save-btn">Save</button>&nbsp;<button class="menu-new-playlist-cancel-btn">Cancel</button></div></div><ul class="menu-items-list"></ul>'},PlaylistsMenuView.prototype.drawPlaylistLink=function(playlist){var a=document.createElement("a");a.href="#page=playlist&id="+playlist.id,a.text=playlist.name,a.title=playlist.name;var li=document.createElement("li");return li.className="truncated",li.appendChild(a),li.outerHTML},PlaylistsMenuView.prototype.showNewPlaylistForm=function(){event.preventDefault();var addForm=this.element.getElementsByClassName("menu-add-playlist-form")[0],addFormNewClasses=addForm.className.replace("hidden","");addForm.className=addFormNewClasses},PlaylistsMenuView.prototype.hideNewPlaylistForm=function(){event.preventDefault();var addForm=this.element.getElementsByClassName("menu-add-playlist-form")[0];addForm.className+=" hidden"},PlaylistsMenuView.prototype.saveNewPlaylist=function(){event.preventDefault();var plName=this.element.getElementsByClassName("new-playlist-name")[0].value;if(""===plName)return this.appEvents.publish("logMsg",{type:"error",msg:"Please specify the name of the playlist"});var isPublic=this.element.getElementsByClassName("public-playlist")[0].checked,self=this;this.playlistModel.createPlaylist(this.user.getId(),{name:plName,"public":isPublic},function(err,playlist){return err?this.appEvents.publish("logMsg",{type:"error",msg:"Error while saving the new the playlist!"}):(self.user.setPlaylist(playlist),self.render(),void self.appEvents.publish("logMsg",{type:"info",msg:"New playlist: "+plName+" is created"}))})},app.Views.PlaylistsMenuView=PlaylistsMenuView}(MYSP),function(app){"use strict";var SearchMenuView=function(options){app.Views.CoreView.call(this,options),this.hideSearch=!1,this.route=options.route,this.appEvents=options.events};SearchMenuView.prototype=Object.create(app.Views.CoreView.prototype),SearchMenuView.prototype.addEventListeners=function(){this.subscribed||(this.subscribed=!0,this.appEvents.subscribe("routeChange",this.reRenderSearchMenuSection.bind(this))),this.addListener("#mysp-menu-search-btn","click",this.doSearch.bind(this)),this.addListener("#mysp-menu-search-input","keyup",this.doSearchOnEnter.bind(this))},SearchMenuView.prototype.render=function(){this.hideSearch=this.route.page&&"search"===this.route.page?!0:!1,this.renderSelf()},SearchMenuView.prototype.getTemplate=function(){var hide=this.hideSearch?"hidden":"";return'<div class="menu-search-form '+hide+'"><input type="text" id="mysp-menu-search-input" value="" placeholder="Search for songs"/><button id="mysp-menu-search-btn">Search</button></div>'},SearchMenuView.prototype.doSearch=function(){var query=document.getElementById("mysp-menu-search-input").value;""!==query&&this.goTo({page:"search",q:query})},SearchMenuView.prototype.doSearchOnEnter=function(){13===window.event.keyCode&&this.doSearch()},SearchMenuView.prototype.reRenderSearchMenuSection=function(newRoute){this.route=newRoute,this.render()},app.Views.SearchMenuView=SearchMenuView}(MYSP),function(app){"use strict";var ContentView=function(options){app.Views.CoreView.call(this,options),this.route=options.route,this.subViews=options.subViews||{},this.appEvents=options.events};ContentView.prototype=Object.create(app.Views.CoreView.prototype),ContentView.prototype.addEventListeners=function(){this.subscribed||(this.subscribed=!0,this.appEvents.subscribe("routeChange",this.renderNewRoute.bind(this)))},ContentView.prototype.render=function(){this.renderSelf();var currentView=this.subViews[app.Config.defaultRoute.page];this.subViews[this.route.page]&&(currentView=this.subViews[this.route.page]),currentView.updateRoute(this.route),currentView.render()},ContentView.prototype.renderNewRoute=function(newRoute){this.route=newRoute,this.render()},app.Views.ContentView=ContentView}(MYSP),function(app){"use strict";var TracksTableView=function(options){this.tracks=options.tracks,this.playlists=options.playlists||[],this.actions=options.actions};TracksTableView.prototype.render=function(){var tracksTbl=this.startTableHeader();return this.tracks.forEach(function(track,index){tracksTbl+=this.drawTrackRow(track,index)},this),tracksTbl+=this.endTable()},TracksTableView.prototype.startTableHeader=function(){return'<table class="mysp-tracks-table" rules="rows" cellspacing="0" cellpadding="3"><thead><tr><th>Song</th><th>Artist</th><th>Album</th><th>Time</th><th>&nbsp;</th></tr></thead><tbody>'},TracksTableView.prototype.endTable=function(){return"</tbody></table>"},TracksTableView.prototype.drawTrackRow=function(track,index){var row='<tr id="track-'+track.uri+'"><td>'+track.name+"</td><td>"+this.showArtists(track)+"</td><td>"+this.showAlbum(track)+"</td><td>"+app.Utils.formatTime(time.duration_ms)+"</td>";return row+="<td>&nbsp;",-1!==this.actions.indexOf("add-to")&&(row+='&nbsp;<select style="width: 200px;" class="mysp-search-results-add-to" data-track-uri="'+track.uri+'">'+this.drawAddToOptions()+"</select>"),-1!==this.actions.indexOf("add-to-queue")&&(row+='&nbsp;<a href="#" class="mysp-track-add-to-queue" rel="'+track.uri+'"title="Add To Current Queue">Add To Queue</a>'),-1!==this.actions.indexOf("remove-from-playlist")&&(row+='&nbsp;<a href="#" class="mysp-playlist-track-remove" rel="'+track.uri+'" data-order="'+index+'"title="Remove track from playlist">Remove</a>'),-1!==this.actions.indexOf("remove-from-queue")&&(row+='&nbsp;<a href="#" class="mysp-queue-track-remove" rel="'+track.uri+'" data-order="'+index+'"title="Remove track from current queue">Remove</a>'),row+="</td></tr>"},TracksTableView.prototype.drawAddToOptions=function(){var options='<option val="">Add To...</option><option disabled>--------------------</option><option value="current-queue">Current Queue</option><option disabled>-------- or --------</option>';for(var id in this.playlists)this.playlists.hasOwnProperty(id)&&(options+='<option value="'+id+'">'+this.playlists[id].name+"</option>");return options},TracksTableView.prototype.showArtists=function(trackModel){var artists="";return trackModel.artists.forEach(function(artist){artists+=', <a href="'+artist.external_urls.spotify+'" target="_blank">',artists+=artist.name+"</a>"}),artists.substring(2)},TracksTableView.prototype.showAlbum=function(trackModel){var album="";return album+='<a href="'+trackModel.album.external_urls.spotify+'" target="_blank">',album+=trackModel.album.name+"</a>"},app.Views.TracksTableView=TracksTableView}(MYSP),function(app){"use strict";var PlaylistDetailsView=function(options){app.Views.CoreView.call(this,options),this.viewState=null,this.appEvents=options.events,this.user=options.user,this.queueModel=options.queueModel,this.playlistModel=null};PlaylistDetailsView.prototype=Object.create(app.Views.CoreView.prototype),PlaylistDetailsView.prototype.addEventListeners=function(){this.addListener(".playlist-details-edit","click",this.setViewMode.bind(this,"edit")),this.addListener(".playlist-details-cancel","click",this.setViewMode.bind(this,"view")),this.addListener(".playlist-details-save","click",this.savePlaylistDetails.bind(this)),this.addListener(".playlist-add-to-queue","click",this.addPlaylistToQueue.bind(this))},PlaylistDetailsView.prototype.getTemplate=function(){var template="",image=this.playlistModel.getImage("medium")||"";image&&(template+='<div class="col-1-3 text-center"><img class="playlist-image" src="'+image+'"/></div>');var secondCol=image?"col-2-3":"col-3-3";return template+='<div class="'+secondCol+'">'+("edit"===this.viewState?this.showEditState():this.showViewState())+"</div>",template+='<button class="playlist-add-to-queue">Add To Queue</button>'},PlaylistDetailsView.prototype.setPlaylistModel=function(playlistModel){this.playlistModel=playlistModel},PlaylistDetailsView.prototype.showViewState=function(){var tmp='<h2 class="playlist-name">'+this.playlistModel.getName()+"</h2>",isPublic=this.playlistModel.isPublic()?"public":"private";return tmp+='<span class="playlist-type">'+isPublic+"</span>",tmp+='<button class="playlist-details-edit pl-btn">Edit</button>'},PlaylistDetailsView.prototype.showEditState=function(){var tmp='<input type="text" class="playlist-details-name pl-control" value="'+this.playlistModel.getName()+'"/>',isPublic=this.playlistModel.isPublic();return tmp+='<select class="playlist-details-type pl-control"><option value="private" '+(isPublic?"":"selected")+'>Private</option><option value="public" '+(isPublic?"selected":"")+">Public</option></select>",tmp+='<button class="playlist-details-save pl-btn">Save</button>&nbsp;<button class="playlist-details-cancel pl-btn">Cancel</button>'},PlaylistDetailsView.prototype.setViewMode=function(mode){this.viewState=mode,this.render()},PlaylistDetailsView.prototype.savePlaylistDetails=function(){var updateData={name:"","public":""};updateData.name=this.element.getElementsByClassName("playlist-details-name")[0].value;var isPublic=this.element.getElementsByClassName("playlist-details-type")[0].value;updateData["public"]="public"===isPublic,this.playlistModel.setName(updateData.name),this.playlistModel.setPublic(updateData["public"]);var self=this;this.playlistModel.updatePlaylistDetails(updateData,function(err){return err?self.appEvents.publish("logMsg",{type:"error",msg:"Error while updating playlist details!"}):(self.user.setPlaylist(self.playlistModel.getData()),self.appEvents.publish("playlistDetailsUpdate",updateData),self.viewState="view",self.render(),void self.appEvents.publish("logMsg",{type:"info",msg:"Playlist details updated"}))})},PlaylistDetailsView.prototype.addPlaylistToQueue=function(){this.queueModel.addTracks(this.playlistModel.getTracks()),this.appEvents.publish("logMsg",{type:"info",msg:"Tracks from "+this.playlistModel.getName()+" are added to playing queue"})},app.Views.PlaylistDetailsView=PlaylistDetailsView}(MYSP),function(app){"use strict";var PlaylistPageView=function(options){app.Views.CoreView.call(this,options),this.route=options.route,this.auth=options.auth,this.user=options.user,this.playlistModel=options.playlistModel};PlaylistPageView.prototype=Object.create(app.Views.CoreView.prototype),PlaylistPageView.prototype.render=function(){if(!this.route.id)return this.goTo({page:"search"});var playlist=this.user.getPlaylist(this.route.id);if(!playlist)return this.goTo({page:"search"});this.renderSelf(),this.playlistModel.reset(),this.playlistModel.setProfile(playlist),this.subViews.playlistDetails.setPlaylistModel(this.playlistModel),this.subViews.playlistTracks.setPlaylistModel(this.playlistModel);var self=this;this.playlistModel.loadTracks(function(err,tracks){if(err){if(-1===err.message.indexOf("401"))return self.goTo({page:"search"});self.auth.logout()}self.renderSubviews()})},PlaylistPageView.prototype.getTemplate=function(){return'<div id="mysp-playlist-details" class="row"></div><div id="mysp-playlist-tracks"></div>'},app.Views.PlaylistPageView=PlaylistPageView}(MYSP),function(app){"use strict";var PlaylistTracksView=function(options){app.Views.CoreView.call(this,options),this.user=options.user,this.appEvents=options.events,this.TracksTableView=options.TracksTableView,this.queueModel=options.queueModel,this.playlistModel=options.playlistModel||null};PlaylistTracksView.prototype=Object.create(app.Views.CoreView.prototype),PlaylistTracksView.prototype.addEventListeners=function(){this.addListener(".mysp-playlist-track-remove","click",this.removeTrackFromPlaylist.bind(this)),this.addListener(".mysp-track-add-to-queue","click",this.addTrackToQueue.bind(this))},PlaylistTracksView.prototype.render=function(){this.renderSelf(!0);var tracks=this.playlistModel.getTracks(),userPlaylists=this.user.getPlaylists(),trackTableTpl=new this.TracksTableView({tracks:tracks,playlists:userPlaylists,actions:["add-to-queue","remove-from-playlist"]}).render();this.element.innerHTML=trackTableTpl,this.addEventListeners()},PlaylistTracksView.prototype.setPlaylistModel=function(playlistModel){
this.playlistModel=playlistModel},PlaylistTracksView.prototype.removeTrackFromPlaylist=function(){event.preventDefault();var trackUri=event.currentTarget.rel,self=this;this.playlistModel.removeTrack(trackUri,function(err){return err?self.appEvents.publish("logMsg",{type:"error",msg:"Error while trying to remove track from playlist!"}):(self.appEvents.publish("logMsg",{type:"info",msg:"Track removed from playlist"}),void(document.getElementById("track-"+trackUri).style.display="none"))})},PlaylistTracksView.prototype.addTrackToQueue=function(){event.preventDefault();var trackUri=event.currentTarget.rel,trackModel=this.playlistModel.getTrackModel(trackUri);this.queueModel.addTracks(trackModel),this.appEvents.publish("logMsg",{type:"info",msg:"Track added to playing queue"})},app.Views.PlaylistTracksView=PlaylistTracksView}(MYSP),function(app){"use strict";var QueuePageView=function(options){app.Views.CoreView.call(this,options)};QueuePageView.prototype=Object.create(app.Views.CoreView.prototype),QueuePageView.prototype.getTemplate=function(){return'<div id="mysp-queue-header" class="row"><h1>Playing Queue</h1></div><div id="mysp-queue-tracks"></div>'},app.Views.QueuePageView=QueuePageView}(MYSP),function(app){"use strict";var QueueTracksView=function(options){app.Views.CoreView.call(this,options),this.appEvents=options.events,this.TracksTableView=options.TracksTableView,this.queueModel=options.queueModel};QueueTracksView.prototype=Object.create(app.Views.CoreView.prototype),QueueTracksView.prototype.addEventListeners=function(){this.addListener(".mysp-queue-track-remove","click",this.removeTrackFromQueue.bind(this))},QueueTracksView.prototype.render=function(){this.renderSelf(!0);var tracks=this.queueModel.getTracks();if(0===tracks.length)queueTpl='<p>The playing queue is empty. <a href="#page=search">Search for songs</a></p>';else var queueTpl=new this.TracksTableView({tracks:tracks,actions:["remove-from-queue"]}).render();this.element.innerHTML=queueTpl,this.addEventListeners()},QueueTracksView.prototype.removeTrackFromQueue=function(){event.preventDefault();var trackOrder=event.currentTarget.getAttribute("data-order");this.queueModel.removeTrack(trackOrder),this.render(),this.appEvents.publish("logMsg",{type:"info",msg:"Track removed from playing queue"}),this.appEvents.publish("trackRemovedFromQueue",trackOrder)},app.Views.QueueTracksView=QueueTracksView}(MYSP),function(app){"use strict";var SearchFormView=function(options){app.Views.CoreView.call(this,options),this.appEvents=options.events};SearchFormView.prototype=Object.create(app.Views.CoreView.prototype),SearchFormView.prototype.addEventListeners=function(){this.addListener("#mysp-search-form-btn","click",this.doSearch.bind(this)),this.addListener("#mysp-search-form-input","keyup",this.doSearchOnEnter.bind(this))},SearchFormView.prototype.getTemplate=function(){var query=this.route.q||"";return'<input id="mysp-search-form-input" class="mysp-search-control" type="text" placeholder="Search for songs" value="'+query+'" /><button id="mysp-search-form-btn" class="mysp-search-control">Search</button>'},SearchFormView.prototype.doSearch=function(){var query=document.getElementById("mysp-search-form-input").value;""!==query&&this.goTo({page:"search",q:query})},SearchFormView.prototype.doSearchOnEnter=function(){13===window.event.keyCode&&this.doSearch()},app.Views.SearchFormView=SearchFormView}(MYSP),function(app){"use strict";var SearchPageView=function(options){app.Views.CoreView.call(this,options),this.route=options.route};SearchPageView.prototype=Object.create(app.Views.CoreView.prototype),SearchPageView.prototype.render=function(){this.renderSelf(),this.updateSubviewsRoute(this.route),this.renderSubviews()},SearchPageView.prototype.getTemplate=function(){return'<div id="mysp-search-form" class="content-section text-center">'+this.route.q+'</div><div id="mysp-search-results" class="content-section text-center"></div>'},app.Views.SearchPageView=SearchPageView}(MYSP),function(app){"use strict";var SearchResultsView=function(options){app.Views.CoreView.call(this,options),this.appEvents=options.events,this.user=options.user,this.searchModel=options.searchModel,this.playlistModel=options.playlistModel,this.queueModel=options.queueModel,this.TracksTableView=options.TracksTableView};SearchResultsView.prototype=Object.create(app.Views.CoreView.prototype),SearchResultsView.prototype.addEventListeners=function(){this.addListener(".mysp-search-results-next","click",this.loadNextResults.bind(this)),this.addListener(".mysp-search-results-add-to","change",this.trackAddTo.bind(this))},SearchResultsView.prototype.render=function(){if(this.renderSelf(!0),this.element.innerHTML="<p>Hello, this is <b>MY Spotify Player</b></p><p>Your playlist from Spotify are displayed in the left column.</p><p>You can manage the tracks or create new playlists from here.</p>",this.route.q&&""!==this.route.q){this.element.innerHTML="Searching...";var self=this;this.searchModel.loadResults(this.route.q,function(err,tracks){return err?this.appEvents.publish("logMsg",{type:"error",msg:"Error while loading search results!"}):void(tracks&&tracks.length>0?(self.element.innerHTML=self.drawResults(),self.addEventListeners()):self.element.innerHTML="No results for: "+self.route.q)})}},SearchResultsView.prototype.drawResults=function(){var userPlaylists=this.user.getPlaylists(),resultsTable=new this.TracksTableView({tracks:this.searchModel.tracks,playlists:userPlaylists,actions:["add-to"]}).render(),loadNextBtn="";return this.searchModel.hasNextResults()&&(loadNextBtn='<div class="text-center"><button class="mysp-search-results-next btn">Load more</button></div>'),resultsTable+loadNextBtn},SearchResultsView.prototype.loadNextResults=function(){var self=this;this.searchModel.loadNextResults(function(err){return err?self.appEvents.publish("logMsg",{type:"error",msg:"Error while loading more search results!"}):void self.render()})},SearchResultsView.prototype.trackAddTo=function(){var self=this,targetElement=window.event.currentTarget,currentValue=targetElement.value;if(""!==currentValue){var trackUri=targetElement.getAttribute("data-track-uri"),tModel=this.searchModel.getTrackModel(trackUri);if("current-queue"===currentValue)tModel&&(this.queueModel.addTracks(tModel),targetElement.selectedIndex=0,this.appEvents.publish("logMsg",{type:"info",msg:tModel.name+" added to playing queue"}));else{var playlistProfile=this.user.getPlaylist(currentValue);this.playlistModel.setProfile(playlistProfile),this.playlistModel.addTracks([trackUri],function(err){return targetElement.selectedIndex=0,err?self.appEvents.publish("logMsg",{type:"error",msg:"Error while adding track to playlist!"}):void self.appEvents.publish("logMsg",{type:"info",msg:tModel.name+", is added to "+self.playlistModel.getName()})})}}},app.Views.SearchResultsView=SearchResultsView}(MYSP),function(app){"use strict";function getMenuView(route,User){return new app.Views.MenuView({element:"mysp-menu",route:route,events:app.Events,subViews:{browseMenu:new app.Views.SearchMenuView({element:"mysp-menu-search",route:route,events:app.Events}),playlistsMenu:new app.Views.PlaylistsMenuView({element:"mysp-menu-playlists",user:User,events:app.Events,playlistModel:new app.Models.Playlist(app.Utils.ajax)})}})}function getContentView(route,User,Auth,Queue){return new app.Views.ContentView({element:"mysp-content",route:route,events:app.Events,subViews:{search:app.ViewsConfig.searchPage(route,User,Auth,Queue),playlist:app.ViewsConfig.playlistPage(route,User,Auth,Queue),queue:app.ViewsConfig.queuePage(route,User,Auth,Queue)}})}function getPlaylistPageView(route,User,Auth,Queue){return new app.Views.PlaylistPageView({element:"mysp-content",route:route,user:User,auth:Auth,playlistModel:new app.Models.Playlist(app.Utils.ajax),subViews:{playlistDetails:new app.Views.PlaylistDetailsView({element:"mysp-playlist-details",events:app.Events,user:User,queueModel:Queue}),playlistTracks:new app.Views.PlaylistTracksView({element:"mysp-playlist-tracks",events:app.Events,user:User,queueModel:Queue,TracksTableView:app.Views.TracksTableView})}})}function getQueuePageView(route,User,Auth,Queue){return new app.Views.QueuePageView({element:"mysp-content",subViews:{queueTracks:new app.Views.QueueTracksView({element:"mysp-queue-tracks",events:app.Events,queueModel:Queue,TracksTableView:app.Views.TracksTableView})}})}function getSearchPageView(route,User,Auth,Queue){return new app.Views.SearchPageView({element:"mysp-content",route:route,subViews:{searchForm:new app.Views.SearchFormView({element:"mysp-search-form",events:app.Events}),searchResults:new app.Views.SearchResultsView({element:"mysp-search-results",events:app.Events,user:User,searchModel:new app.Models.Search(app.Utils.ajax),playlistModel:new app.Models.Playlist(app.Utils.ajax),queueModel:Queue,TracksTableView:app.Views.TracksTableView})}})}app.ViewsConfig.menu=getMenuView,app.ViewsConfig.content=getContentView,app.ViewsConfig.playlistPage=getPlaylistPageView,app.ViewsConfig.queuePage=getQueuePageView,app.ViewsConfig.searchPage=getSearchPageView}(MYSP),function(app){"use strict";function showLogin(){Auth.addLoginCallbackListener(),new app.Views.LoginView({element:"mysp-container",auth:Auth}).render()}function initAppForUser(){app.Utils.ajax.token=Auth.getToken(),User=new app.Models.User(app.Utils.ajax),User.loadProfile(function(err,usr){if(err)return Auth.logout();Auth.setId(usr.getId());var hashStr=window.location.hash,route=""!==hashStr?app.Utils.hashToObject(hashStr):app.Config.defaultRoute;usr.loadPlaylists(function(err){if(err)return void console.log("problem while loading playlists");var appView=new app.Views.AppView({element:"mysp-container",auth:Auth,user:User,subViews:{menu:app.ViewsConfig.menu(route,User,Auth,Queue),content:app.ViewsConfig.content(route,User,Auth,Queue),logger:new app.Views.LoggerView({element:"mysp-info-box",events:app.Events}),player:new app.Views.PlayerView({element:"mysp-player-container",events:app.Events,queueModel:Queue})}});appView.render()})})}var Auth=new app.Models.Auth(app.Config),Queue=new app.Models.Queue(app.Config),User=null;app.Events=new app.Models.Events,window.addEventListener("hashchange",function(e){var hashString=e.newURL.split("#")[1],route=app.Utils.hashToObject(hashString);app.Events.publish("routeChange",route)}),""===Auth.getToken()?showLogin():initAppForUser()}(MYSP);